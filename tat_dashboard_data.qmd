---
title: "tat_dashboard_data"
author: "Arush Mohan"
date: "`r Sys.Date()`"
params:
  input_dir: "data/providers"  # Path to the directory where provider folders are stored
  output_file: "output/processed_data.csv"  # Output path for the combined data
  submission_month: "2024-08"  # The month of data submission 
format: html
editor: visual
---

##Setup

```{r}
# Load necessary libraries
library(tidyverse)
library(lubridate)
library(stringr)
library(janitor)
library(odbc)
library(DBI)

# Define parameters for the file paths and other variables
input_dir <- params$input_dir
output_file <- params$output_file
submission_month <- params$submission_month

```

##Load Provider Data Files

```{r}

# Function to load and process provider data
load_provider_data <- function(input_dir) {
  # List all files in the input directory recursively
  all_files <- list.files(input_dir, recursive = TRUE, full.names = TRUE, pattern = "*.csv")
  
  # Extract metadata from filenames (submission date, provider code, month-year, data type)
  provider_data <- tibble(file_path = all_files) %>%
    mutate(
      file_name = basename(file_path),
      submission_date = str_extract(file_name, "^\\d{8}"),
      submission_date = ymd(submission_date),
      month_year = str_extract(file_name, "[A-Za-z]{3}\\d{2}"),
      data_type = ifelse(str_detect(file_name, "Freeze"), "Freeze", "Flex")
    )
  
  return(provider_data)
}

# Load provider files into a dataframe
provider_files <- load_provider_data(input_dir)


```

##Clean and Transform Data

```{r}

# Function to clean individual CSVs and normalize column names
process_provider_files <- function(provider_files) {
  processed_data <- provider_files %>%
    # Read CSVs into R
    rowwise() %>%
    mutate(data = list(read_csv(file_path) %>%
                         # Normalize column names: make them lowercase and replace spaces with underscores
                         janitor::clean_names(case = "snake"))) %>%
    unnest(data) %>%
    # Extract month and year
    mutate(
      month = str_sub(month_year, 1, 3),
      year = paste0("20", str_sub(month_year, 4, 5)),
      submission_month = month(submission_date),
      submission_year = year(submission_date)
    ) %>%
    # Reorder and add necessary columns
    select(submission_date, data_type, month, year, everything()) %>%
    ungroup()
  
  return(processed_data)
}

# Process the files into a single dataset
combined_data <- process_provider_files(provider_files)

```

##Save the Combined Dataset

```{r}

# Write the combined data to a CSV file
write_csv(combined_data, output_file)

# Output a message
cat("Processed data saved to:", output_file)

```

##Uploading Combined Dataset to the Sandpit

###Establishing a connection ot the Sandpit
```{r}

# Connecting to the Sandpit

con <- dbConnect(odbc::odbc(), 
                 dsn = "SANDPIT",
                 database = "Data_Lab_NCL",
                 TrustedConnection = TRUE)
```


###Uploading the data and transforming according to type
```{r}

# Function to replace or append data based on the data type (freeze or flex)
upload_to_sql <- function(combined_data, con, table_name) {
  
  # Split the combined dataset into freeze and flex data
  freeze_data <- combined_data %>% filter(data_type == "Freeze")
  flex_data <- combined_data %>% filter(data_type == "Flex")
  
  # Replace old flex data with freeze data
  for (i in seq_len(nrow(freeze_data))) {
    freeze_row <- freeze_data[i, ]
    provider_code <- freeze_row$provider_code
    month <- freeze_row$month
    year <- freeze_row$year
    
    tryCatch({
      # SQL Query to delete old flex data for the freeze month
      delete_query <- paste0("DELETE FROM ", table_name, 
                             " WHERE provider_code = '", provider_code, 
                             "' AND month = '", month, 
                             "' AND year = '", year, 
                             "' AND data_type = 'Flex'")
      
      # Execute the delete query
      dbExecute(con, delete_query)
      message("Old flex data for ", provider_code, " (", month, " ", year, ") successfully deleted.")
      
      # Insert the freeze data into the SQL table
      dbWriteTable(con, table_name, freeze_row, append = TRUE, row.names = FALSE)
      message("New freeze data for ", provider_code, " (", month, " ", year, ") successfully uploaded.")
      
    }, error = function(e) {
      warning("Error processing freeze data for ", provider_code, " (", month, " ", year, "): ", e$message)
    })
  }
  
  # For the flex data, either replace or append
  for (i in seq_len(nrow(flex_data))) {
    flex_row <- flex_data[i, ]
    provider_code <- flex_row$provider_code
    month <- flex_row$month
    year <- flex_row$year
    
    tryCatch({
      # SQL Query to check if flex data already exists
      check_query <- paste0("SELECT COUNT(*) FROM ", table_name, 
                            " WHERE provider_code = '", provider_code, 
                            "' AND month = '", month, 
                            "' AND year = '", year, 
                            "' AND data_type = 'Flex'")
      
      # Execute the query to check existence
      result <- dbGetQuery(con, check_query)
      
      if (result[1, 1] > 0) {
        # If flex data exists, delete the old flex data
        delete_query <- paste0("DELETE FROM ", table_name, 
                               " WHERE provider_code = '", provider_code, 
                               "' AND month = '", month, 
                               "' AND year = '", year, 
                               "' AND data_type = 'Flex'")
        dbExecute(con, delete_query)
        message("Existing flex data for ", provider_code, " (", month, " ", year, ") successfully deleted.")
      }
      
      # Insert the new flex data into the SQL table
      dbWriteTable(con, table_name, flex_row, append = TRUE, row.names = FALSE)
      message("New flex data for ", provider_code, " (", month, " ", year, ") successfully uploaded.")
      
    }, error = function(e) {
      warning("Error processing flex data for ", provider_code, " (", month, " ", year, "): ", e$message)
    })
  }
}

# Example of running the upload process
tryCatch({
  con <- connect_to_sql()
  upload_to_sql(combined_data, con, "your_sql_table_name")
}, error = function(e) {
  warning("Error in the upload process: ", e$message)
}, finally = {
  if (exists("con") && !is.null(con)) {
    dbDisconnect(con)
    message("Disconnected from SQL Server.")
  }
})


```